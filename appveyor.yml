version: '{build}'
branches:
  only:
  - winbuild
clone_folder: C:\build
init:
- ps: "$url = \"https://static.rust-lang.org/rustup/dist/i686-pc-windows-gnu/rustup-init.exe\" \n$output = \"C:\\temp\\rustup-init.exe\"\nmkdir \"C:\\temp\\\"\nInvoke-WebRequest -Uri $url -OutFile $output"
clone_script:
- cmd: >-
    git clone --recursive --branch=winbuild https://github.com/AleXr64/grip.git C:\build

    mkdir %BUILD_ROOT%\build\debug\rust

    mkdir %BUILD_ROOT%\build\release\rust
environment:
  BUILD_ROOT: C:\build
  PATH: '%PATH%;%USERPROFILE%\.cargo\bin'
  RUST_BACKTRACE: 1
install:
- cmd: >-
    C:\temp\rustup-init.exe -y

    setx /M path "%path%;%USERPROFILE%\.cargo\bin"

    rustup target add i686-pc-windows-gnu
cache:
- '%USERPROFILE%\.cargo\'
- '%BUILD_ROOT%\build\'
build_script:
- cmd: >-
    set PATH=C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\CMake\bin;C:\Program Files\LLVM\bin;C:\Program Files (x86)\Yarn\bin\;C:\Users\appveyor\AppData\Roaming\npm;C:\Program Files\PowerShell\6\;C:\ProgramData\chocolatey\bin;C:\Program Files (x86)\nodejs\;C:\Users\appveyor\.dotnet\tools;C:\Users\appveyor\AppData\Local\Yarn\bin;C:\Users\appveyor\AppData\Roaming\npm;C:\Program Files\AppVeyor\BuildAgent\;C:\Users\appveyor\.cargo\bin;C:/mingw-w64/i686-6.3.0-posix-dwarf-rt_v5-rev1/mingw32/bin


    cd %BUILD_ROOT%\build\Debug

    cmake %BUILD_ROOT% -DCMAKE_BUILD_TYPE=Debug -DWIN32=true -DCMAKE_TOOLCHAIN_FILE=%BUILD_ROOT%/mingw-w64-x86_64.cmake -G "MinGW Makefiles"

    cd rust

    mingw32-make

    cd ../

    mingw32-make




    cd %BUILD_ROOT%\build\Release

    cmake %BUILD_ROOT% -DCMAKE_BUILD_TYPE=Release -DWIN32=true -DCMAKE_TOOLCHAIN_FILE=%BUILD_ROOT%/mingw-w64-x86_64.cmake -G "MinGW Makefiles"

    cd rust

    mingw32-make

    cd ../

    mingw32-make
test_script:
- cmd: >-
    cd %BUILD_ROOT%/rust


    SET CARGO_TARGET_DIR=%BUILD_ROOT%/build/debug/rust

    cargo test --verbose --target i686-pc-windows-gnu


    SET CARGO_TARGET_DIR=%BUILD_ROOT%/build/release/rust

    cargo test --verbose --release --target i686-pc-windows-gnu
before_deploy:
- cmd: >-
    set PATH=C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\CMake\bin;C:\Program Files\LLVM\bin;C:\Program Files (x86)\Yarn\bin\;C:\Users\appveyor\AppData\Roaming\npm;C:\Program Files\PowerShell\6\;C:\ProgramData\chocolatey\bin;C:\Program Files (x86)\nodejs\;C:\Users\appveyor\.dotnet\tools;C:\Users\appveyor\AppData\Local\Yarn\bin;C:\Users\appveyor\AppData\Roaming\npm;C:\Program Files\AppVeyor\BuildAgent\;C:\Users\appveyor\.cargo\bin;C:/mingw-w64/i686-6.3.0-posix-dwarf-rt_v5-rev1/mingw32/bin;C:\Program Files\7-Zip

    cd %BUILD_ROOT%

    mkdir deploy\addons\amxmodx\modules

    mkdir deploy\addons\amxmodx\configs

    mkdir deploy\addons\amxmodx\scripting

    copy %BUILD_ROOT%\build\release\*.dll %BUILD_ROOT%\deploy\addons\amxmodx\modules\

    copy %BUILD_ROOT%\configs\* %BUILD_ROOT%\deploy\addons\amxmodx\configs\

    copy %BUILD_ROOT%\scripting\* %BUILD_ROOT%\deploy\addons\amxmodx\scripting\

    cd %BUILD_ROOT%\deploy

    7z.exe a grip-amxx_win-%appveyor_build_version%.7z addons

    appveyor PushArtifact grip-amxx_win-%appveyor_build_version%.7z
deploy:
- provider: GitHub
  release: grip-amxx_win-build$(appveyor_build_version)
  description: Test Release description
  auth_token:
    secure: 4uYyk4p3vMNLTGm8ahlvBDFmnLTLCct1gmKw7H1zNUacm0LnP/o/txgh2gOlqex0
  artifact: grip-amxx_win-$(appveyor_build_version).7z
  draft: false
  prerelease: false
  force_update: true
  on:
    branch: winbuild