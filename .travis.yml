language: rust
compiler:
  - clang
  - gcc
rust:
  - stable
  - beta
  - nightly
env: 
  global:
  - PKG_CONFIG_ALLOW_CROSS=1
  - TARGET=i686-unknown-linux-gnu 
os:
  - linux
matrix:
  allow_failures:
    - rust: nightly
  fast_finish: true
addons:
  apt:""
    packages:
    - libssl-dev:i386
    - lib32stdc++6
    - lib32z1-dev
    - libc6-dev-i386
    - linux-libc-dev
    - gcc-multilib
    - g++-multilib
install:
  - rustup target add $TARGET
script: 
  - cmake --version
  - mkdir build && cd build

  - mkdir build_debug && cd build_debug
  - cmake ../../ -DCMAKE_BUILD_TYPE=Debug
  - make -j$((2 * `getconf _NPROCESSORS_ONLN))`
  
  - cd - && mkdir build_release && cd build_release
  - cmake ../../ -DCMAKE_BUILD_TYPE=Release
  - make -j$((2 * `getconf _NPROCESSORS_ONLN))`

  - cd - && mkdir build_test && cd ../rust
  - CARGO_TARGET_DIR=./build/build_test cargo test --target $TARGET
  - CARGO_TARGET_DIR=./build/build_test cargo test --release --target $TARGET

cache: cargo
  directories:
    - ./build/build_test
before_cache:
# Travis can't cache files that are not readable by "others"
- chmod -R a+r $HOME/.cargoit s