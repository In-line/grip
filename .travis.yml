language: rust
compiler:
  - clang
  - gcc
rust:
  - stable
  - beta
  - nightly
env: 
  - PKG_CONFIG_ALLOW_CROSS=1 TARGET=i686-unknown-linux-gnu 
os:
  - linux
matrix:
  allow_failures:
    - rust: nightly
  fast_finish: true
addons:
  apt:
    packages:
    - libssl-dev:i386
    - lib32stdc++6
    - lib32z1-dev
    - libc6-dev-i386
    - linux-libc-dev
    - gcc-multilib
    - g++-multilib
    - ninja
install:
  - rustup target add $TARGET
script: 
  - cmake --version
  - mkdir -p build && cd build

  - mkdir -p build_debug && cd build_debug
  - cmake ../../ -G Ninja -DCMAKE_BUILD_TYPE=Debug
  - ninja
  
  - cd - && mkdir -p build_release && cd build_release
  - cmake ../../ -G Ninja   -DCMAKE_BUILD_TYPE=Release
  - ninja

  - cd - && mkdir -p build_test && cd ../rust
  - CARGO_TARGET_DIR=./build/build_test cargo test --target $TARGET
  - CARGO_TARGET_DIR=./build/build_test cargo test --release --target $TARGET

cache:
  cargo: true
  directories:
    - ./build/build_test
before_cache:
# Travis can't cache files that are not readable by "others"
- chmod -R a+r $HOME/.cargo